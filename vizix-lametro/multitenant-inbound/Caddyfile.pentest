# HTTPS Termination happens in Azure WAF
# This is only HTTP 80

:80 {
  #tls /root/.caddy/wildcard.red.vizix.io/bundle-ca.pem /root/.caddy/wildcard.red.vizix.io/key.pem
  tls off
  gzip
#  log / stdout "{remote} - {user} [{when}] \"{method} {uri} {proto}\" {status} {size} {latency}"
 # log / stdout "From: {remote} - {user} [{when}] \"{method} {uri} {proto}\" Headers:: Accept-encoding: {>accept-encoding}, Content-Type: {>Content-Type}, Content Lenght {>Content-Length} , Body {request_body}, {mitm} {query} {status} {size} {latency}"
   log / stdout "From: {remote} - {user} [{when}] \"{method} {uri} {proto}\" Headers:: Accept-encoding: {>accept-encoding}, Authorization: {>authorization} ----ENDS AUTH ,Content-Type: {>Content-Type} ----ENDS CONTENT, Content Lenght {>Content-Length} , Body {request_body}, {mitm} {query} {status} {size} {latency}"
  errors stderr
  timeouts 2h

#added for pentest 13-8-19
  header / {
  Access-Control-Allow-Origin https://staging.red.vizix.io
  Strict-Transport-Security "max-age=31536000;"
  Referrer-Policy "no-referrer"
 # Content-Security-Policy "default-src 'none';"

  Content-Security-Policy "default-src *; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src *; img-src * 'self' data:; style-src * 'unsafe-inline' 'unsafe-eval'; style-src-elem * 'unsafe-inline'"

  Feature-Policy "accelerometer 'self'; ambient-light-sensor 'self'; autoplay 'none'; camera 'self'; encrypted-media 'none'; fullscreen 'self'; geolocation 'self'; gyroscope 'none'; magnetometer 'none'; microphone 'self'; midi 'none'; payment 'none'; picture-in-picture 'self'; speaker 'self'; usb 'none'; vr 'none';"
  X-Content-Type-Options "nosniff"
  X-Frame-Options "SAMEORIGIN"
#  X-Frame-Options "DENY"
  X-XSS-Protection "1; mode=block"
  -Server
  }

cors / {
   origin https://staging.red.vizix.io
#   methods GET,POST,PUT,DELETE,OPTIONS,PATCH
   allow_credentials true
#   allowed_headers   Origin,X-Requested-With,Content-Type,Accept,Authorization
}



  proxy / ui:80 {
    policy round_robin
    health_check /console/scripts/config.js
    transparent
  }

##########################################
#                                        #
#   Last rule for /riot-core-SERVICES    #
#                                        #
##########################################

  proxy /riot-core-services services:8080 {
    policy round_robin
    health_check /riot-core-services/api/swagger.json
    transparent
  }

##########################################
#                                        #
# Rewrite and redirect from Mobile PATCH #
#    To do: improve performance          #
#                                        #
##########################################
  proxy /vizix-cdn minio:9000 {
    transparent
    without /vizix-cdn
  }

  proxy /minio minio:9000 {
    transparent
  }

  proxy /merchandising-dashboard externaltransformer:8080 {
    transparent
    policy round_robin
  }

  rewrite /riot-core-services {
    if {path} has thingBridge
    r /api(.*)
    to /http-bridge{1}
  }

  proxy /http-bridge hbridge:8080 {
    policy round_robin
    health_check /http-bridge/thingBridge/thing
    transparent
    websocket
  }

#  proxy /vizix-stack vstack:80 {
#    transparent
#    without /vizix-stack
#  }

##########################################
#                                        #
#   Rules for /CXI Endpoints             #
#                                        #
##########################################

  proxy /serialization-api externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /epcis-core externaltransformer:8080 {
    policy round_robin
    transparent
  }

  proxy /statemachine-api-dashboard-monitoring externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /statemachine-api-monitoring externaltransformer:8080 {
    policy round_robin
    transparent
  }

  proxy /api externaltransformer:8080 {
    policy round_robin
    transparent
  }

  proxy /notifications https://onesignal.com/api/v1/notifications {
  without /notifications
  }

  proxy /static externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /epcis-events-input-rest/rest externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /statemachine-api-status-rest/rest externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /statemachine-epcis-events-input-rest externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /statemachine-api-configuration/rest externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /statemachine-api-aggregates/rest externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /product-recommendation-api/rest externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /product-api/rest externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /statemachine-api-supervision/rest externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /supply-chain-api/rest externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /supply_chain/transactions externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /results externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /configurations externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /statemachine-epcis-events-input-rest externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /openapi externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /backoffice externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /printing-api/rest externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /printing-dashboard externaltransformer:8080 {
    policy round_robin
    transparent
  }
   proxy /statemachine-api-dashboard-configuration externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /configuration-dashboard externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /statemachine-api-monitoring externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /digital-signature externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /tag-management externaltransformer:8080 {
    policy round_robin
    transparent
  }
  proxy /tag-management-ws externaltransformer:8080 {
    policy round_robin
    transparent
  }

  redir /flow /flow/

  proxy /flow flow:1880 {
    policy round_robin
    without /flow
#    health_check /
    transparent
    websocket
  }
}

##########################################
#                                        #
#   ALE messages rewrite to HTTPBridge   #
#                                        #
##########################################

:9090 {
  tls off
  log stdout
  errors stderr
  timeouts 2h

  rewrite / {
    r (.*)
    to /http-bridge/v1/data/<SPECNAME>/<THINGTYPE>/{1}
  }

  proxy / <private-ip-httpbridge>:9999 {
    policy round_robin
    health_check /http-bridge/thingBridge/thing
    transparent
  }
}

kibana.staging.red.vizix.io:443 {

tls infrastructure@mojix.com
#tls off
gzip
log / stdout "{remote} - {user} [{when}] \"{method} {uri} {proto}\" {status} {size} {latency}"

  proxy / shopcx-kibana:5601 {
    transparent
    policy round_robin
  }

}

##########################################
#                                        #
#        Notebooks and Dashboards        #
#                                        #
##########################################


notebooks-staging.red.vizix.io:443 {
    tls /root/.caddy/wildcard.red.vizix.io/bundle-ca.pem /root/.caddy/wildcard.red.vizix.io/key.pem
    log / stdout "{remote} - {user} [{when}] \"{method} {uri} {proto}\" {status} {size} {latency}"
    errors stderr
    timeouts 2h

    redir /notebooksapi /notebooksapi/
    proxy /notebooksapi notebooks_api:8999 {
      without /notebooksapi
      transparent
      websocket
    }

    proxy / notebooks:8888 {
      transparent
      websocket
    }
}

analytics-staging.red.vizix.io:443 {
    tls /root/.caddy/wildcard.red.vizix.io/bundle-ca.pem /root/.caddy/wildcard.red.vizix.io/key.pem
    log / stdout "{remote} - {user} [{when}] \"{method} {uri} {proto}\" {status} {size} {latency}"
    errors stderr
    timeouts 2h

    proxy /dashboards analytics:3000 {
      transparent
    }

    proxy /css analytics:3000 {
      transparent
    }

    proxy /components analytics:3000 {
      transparent
    }

    proxy /api analytics:3000 {
      websocket
      transparent
    }
}

### Vizix Stack
status-staging.red.vizix.io:443 {
    tls /root/.caddy/wildcard.red.vizix.io/bundle-ca.pem /root/.caddy/wildcard.red.vizix.io/key.pem
    log / stdout "{remote} - {user} [{when}] \"{method} {uri} {proto}\" {status} {size} {latency}"
    errors stderr
    timeouts 2h

    proxy / vstack:80 {
      transparent
      websocket
    }

    ipfilter /apis {
      rule allow
      ip 190.181.5.56/29 147.75.99.67/32
    }

    redir /apis /apis/
    proxy /apis viz_docker:8080 {
      transparent
    }
}
